import { Pool } from "pg";
import type { QueryResult, QueryResultRow } from "pg";
import { ENV } from "./_core/env";

const pool = ENV.supabaseDbUrl
  ? new Pool({ connectionString: ENV.supabaseDbUrl })
  : null;

if (!pool) {
  console.warn(
    "[Database] SUPABASE_DB_URL is not defined. Database operations will fail."
  );
}

async function query<T extends QueryResultRow = QueryResultRow>(
  text: string,
  params: unknown[] = []
): Promise<QueryResult<T>> {
  if (!pool) {
    throw new Error("Database client not initialized. Set SUPABASE_DB_URL.");
  }
  return pool.query<T>(text, params);
}

type CategoryRow = {
  id: number;
  name_pt: string;
  slug: string;
  display_order: number;
  is_active: boolean;
  created_at: Date;
  updated_at: Date;
};

type MenuItemRow = {
  id: number;
  category_id: number;
  name_pt: string;
  description_pt: string | null;
  price: number;
  image_url: string | null;
  is_vegetarian: boolean;
  is_vegan: boolean;
  is_gluten_free: boolean;
  is_spicy: boolean;
  is_featured: boolean;
  is_available: boolean;
  display_order: number;
  created_at: Date;
  updated_at: Date;
};

type TranslationRow = {
  id: number;
  entity_type: "category" | "menu_item";
  entity_id: number;
  field_name: "name" | "description";
  language: string;
  translated_text: string;
  created_at: Date;
  updated_at: Date;
};

type UserProfileRow = {
  user_id: string;
  full_name: string | null;
  role: "user" | "admin";
  created_at: Date;
  updated_at: Date;
};

export type MenuCategory = {
  id: number;
  namePt: string;
  slug: string;
  displayOrder: number;
  isActive: boolean;
  createdAt: Date;
  updatedAt: Date;
};

export type MenuItem = {
  id: number;
  categoryId: number;
  namePt: string;
  descriptionPt: string | null;
  price: number;
  imageUrl: string | null;
  isVegetarian: boolean;
  isVegan: boolean;
  isGlutenFree: boolean;
  isSpicy: boolean;
  isFeatured: boolean;
  isAvailable: boolean;
  displayOrder: number;
  createdAt: Date;
  updatedAt: Date;
};

export type Translation = {
  id: number;
  entityType: "category" | "menu_item";
  entityId: number;
  fieldName: "name" | "description";
  language: string;
  translatedText: string;
  createdAt: Date;
  updatedAt: Date;
};

export type UserProfile = {
  userId: string;
  fullName: string | null;
  role: "user" | "admin";
  createdAt: Date;
  updatedAt: Date;
};

function mapCategory(row: CategoryRow): MenuCategory {
  return {
    id: row.id,
    namePt: row.name_pt,
    slug: row.slug,
    displayOrder: row.display_order,
    isActive: row.is_active,
    createdAt: row.created_at,
    updatedAt: row.updated_at,
  };
}

function mapMenuItem(row: MenuItemRow): MenuItem {
  return {
    id: row.id,
    categoryId: row.category_id,
    namePt: row.name_pt,
    descriptionPt: row.description_pt,
    price: row.price,
    imageUrl: row.image_url,
    isVegetarian: row.is_vegetarian,
    isVegan: row.is_vegan,
    isGlutenFree: row.is_gluten_free,
    isSpicy: row.is_spicy,
    isFeatured: row.is_featured,
    isAvailable: row.is_available,
    displayOrder: row.display_order,
    createdAt: row.created_at,
    updatedAt: row.updated_at,
  };
}

function mapTranslation(row: TranslationRow): Translation {
  return {
    id: row.id,
    entityType: row.entity_type,
    entityId: row.entity_id,
    fieldName: row.field_name,
    language: row.language,
    translatedText: row.translated_text,
    createdAt: row.created_at,
    updatedAt: row.updated_at,
  };
}

function mapProfile(row: UserProfileRow): UserProfile {
  return {
    userId: row.user_id,
    fullName: row.full_name,
    role: row.role,
    createdAt: row.created_at,
    updatedAt: row.updated_at,
  };
}

export async function getAllCategories(): Promise<MenuCategory[]> {
  const { rows } = await query<CategoryRow>(
    `SELECT id, name_pt, slug, display_order, is_active, created_at, updated_at
     FROM categories
     WHERE is_active = true
     ORDER BY display_order ASC`
  );
  return rows.map(mapCategory);
}

export async function getCategoryBySlug(slug: string): Promise<MenuCategory | undefined> {
  const { rows } = await query<CategoryRow>(
    `SELECT id, name_pt, slug, display_order, is_active, created_at, updated_at
     FROM categories
     WHERE slug = $1
     LIMIT 1`,
    [slug]
  );
  return rows.length > 0 ? mapCategory(rows[0]) : undefined;
}

export async function getMenuItemsByCategory(categoryId: number): Promise<MenuItem[]> {
  const { rows } = await query<MenuItemRow>(
    `SELECT * FROM menu_items
     WHERE category_id = $1
     ORDER BY display_order ASC`,
    [categoryId]
  );
  return rows.map(mapMenuItem);
}

export async function getAllMenuItems(): Promise<MenuItem[]> {
  const { rows } = await query<MenuItemRow>(
    `SELECT * FROM menu_items
     ORDER BY display_order ASC`
  );
  return rows.map(mapMenuItem);
}

export async function getTranslations(
  entityType: "category" | "menu_item",
  entityId: number,
  language: string
): Promise<Translation[]> {
  const { rows } = await query<TranslationRow>(
    `SELECT * FROM translations
     WHERE entity_type = $1 AND entity_id = $2 AND language = $3`,
    [entityType, entityId, language]
  );
  return rows.map(mapTranslation);
}

export async function upsertTranslation(input: {
  entityType: "category" | "menu_item";
  entityId: number;
  fieldName: "name" | "description";
  language: string;
  translatedText: string;
}): Promise<void> {
  await query(
    `INSERT INTO translations (entity_type, entity_id, field_name, language, translated_text)
     VALUES ($1, $2, $3, $4, $5)
     ON CONFLICT (entity_type, entity_id, field_name, language)
     DO UPDATE SET translated_text = EXCLUDED.translated_text, updated_at = NOW()`,
    [
      input.entityType,
      input.entityId,
      input.fieldName,
      input.language,
      input.translatedText,
    ]
  );
}

export async function createCategory(input: {
  namePt: string;
  slug: string;
  displayOrder?: number;
  isActive?: boolean;
}): Promise<MenuCategory> {
  const { rows } = await query<CategoryRow>(
    `INSERT INTO categories (name_pt, slug, display_order, is_active)
     VALUES ($1, $2, $3, $4)
     RETURNING id, name_pt, slug, display_order, is_active, created_at, updated_at`,
    [input.namePt, input.slug, input.displayOrder ?? 0, input.isActive ?? true]
  );
  return mapCategory(rows[0]);
}

export async function createMenuItem(input: {
  categoryId: number;
  namePt: string;
  descriptionPt?: string | null;
  price: number;
  imageUrl?: string | null;
  isVegetarian?: boolean;
  isVegan?: boolean;
  isGlutenFree?: boolean;
  isSpicy?: boolean;
  isFeatured?: boolean;
  isAvailable?: boolean;
  displayOrder?: number;
}): Promise<MenuItem> {
  const { rows } = await query<{ id: number }>(
    `INSERT INTO menu_items (
      category_id,
      name_pt,
      description_pt,
      price,
      image_url,
      is_vegetarian,
      is_vegan,
      is_gluten_free,
      is_spicy,
      is_featured,
      is_available,
      display_order
    ) VALUES (
      $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12
    ) RETURNING id`,
    [
      input.categoryId,
      input.namePt,
      input.descriptionPt ?? null,
      input.price,
      input.imageUrl ?? null,
      input.isVegetarian ?? false,
      input.isVegan ?? false,
      input.isGlutenFree ?? false,
      input.isSpicy ?? false,
      input.isFeatured ?? false,
      input.isAvailable ?? true,
      input.displayOrder ?? 0,
    ]
  );
  const id = rows[0].id;
  const item = await getMenuItemById(id);
  return item;
}

export async function updateMenuItemAvailability(
  itemId: number,
  isAvailable: boolean
): Promise<void> {
  await query(
    `UPDATE menu_items
     SET is_available = $1, updated_at = NOW()
     WHERE id = $2`,
    [isAvailable, itemId]
  );
}

export async function getMenuItemById(itemId: number): Promise<MenuItem> {
  const { rows } = await query<MenuItemRow>(
    `SELECT * FROM menu_items WHERE id = $1 LIMIT 1`,
    [itemId]
  );
  if (rows.length === 0) {
    throw new Error("Menu item not found");
  }
  return mapMenuItem(rows[0]);
}

export async function getAllTranslationsForEntity(
  entityType: "category" | "menu_item",
  entityId: number
): Promise<Translation[]> {
  const { rows } = await query<TranslationRow>(
    `SELECT * FROM translations
     WHERE entity_type = $1 AND entity_id = $2`,
    [entityType, entityId]
  );
  return rows.map(mapTranslation);
}

export async function updateMenuItem(
  itemId: number,
  input: {
    categoryId: number;
    namePt: string;
    descriptionPt?: string | null;
    price: number;
    imageUrl?: string | null;
    isVegetarian?: boolean;
    isVegan?: boolean;
    isGlutenFree?: boolean;
    isSpicy?: boolean;
    isFeatured?: boolean;
    isAvailable?: boolean;
    displayOrder?: number;
  }
): Promise<void> {
  await query(
    `UPDATE menu_items SET
      category_id = $1,
      name_pt = $2,
      description_pt = $3,
      price = $4,
      image_url = $5,
      is_vegetarian = $6,
      is_vegan = $7,
      is_gluten_free = $8,
      is_spicy = $9,
      is_featured = $10,
      is_available = $11,
      display_order = $12,
      updated_at = NOW()
    WHERE id = $13`,
    [
      input.categoryId,
      input.namePt,
      input.descriptionPt ?? null,
      input.price,
      input.imageUrl ?? null,
      input.isVegetarian ?? false,
      input.isVegan ?? false,
      input.isGlutenFree ?? false,
      input.isSpicy ?? false,
      input.isFeatured ?? false,
      input.isAvailable ?? true,
      input.displayOrder ?? 0,
      itemId,
    ]
  );
}

export async function getUserProfile(userId: string): Promise<UserProfile | null> {
  const { rows } = await query<UserProfileRow>(
    `SELECT user_id, full_name, role, created_at, updated_at
     FROM user_profiles
     WHERE user_id = $1
     LIMIT 1`,
    [userId]
  );
  return rows.length > 0 ? mapProfile(rows[0]) : null;
}

export async function upsertUserProfile(input: {
  userId: string;
  fullName?: string | null;
  role?: "user" | "admin";
}): Promise<UserProfile> {
  const { rows } = await query<UserProfileRow>(
    `INSERT INTO user_profiles (user_id, full_name, role)
     VALUES ($1, $2, $3)
     ON CONFLICT (user_id)
     DO UPDATE SET full_name = EXCLUDED.full_name, role = EXCLUDED.role, updated_at = NOW()
     RETURNING user_id, full_name, role, created_at, updated_at`,
    [input.userId, input.fullName ?? null, input.role ?? "user"]
  );
  return mapProfile(rows[0]);
}
